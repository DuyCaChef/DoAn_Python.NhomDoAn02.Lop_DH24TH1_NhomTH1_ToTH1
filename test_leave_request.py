"""
Test Script - Leave Request System
Kiá»ƒm tra tÃ­nh nÄƒng yÃªu cáº§u nghá»‰ phÃ©p
"""
from app.database.connection import create_connection
from app.database.leave_request_queries import LeaveRequestQueries
from app.controllers.leave_request_controller import LeaveRequestController


def test_database_connection():
    """Test 1: Kiá»ƒm tra káº¿t ná»‘i database"""
    print("=" * 60)
    print("TEST 1: Kiá»ƒm tra káº¿t ná»‘i database")
    print("=" * 60)
    try:
        conn = create_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM leave_requests")
        count = cursor.fetchone()[0]
        cursor.close()
        conn.close()
        print(f"âœ… Káº¿t ná»‘i thÃ nh cÃ´ng! Hiá»‡n cÃ³ {count} yÃªu cáº§u trong DB")
        return True
    except Exception as e:
        print(f"âŒ Lá»—i káº¿t ná»‘i: {e}")
        return False


def test_table_structure():
    """Test 2: Kiá»ƒm tra cáº¥u trÃºc báº£ng"""
    print("\n" + "=" * 60)
    print("TEST 2: Kiá»ƒm tra cáº¥u trÃºc báº£ng leave_requests")
    print("=" * 60)
    try:
        conn = create_connection()
        cursor = conn.cursor()
        cursor.execute("DESCRIBE leave_requests")
        columns = cursor.fetchall()
        
        print("\nCÃ¡c cá»™t trong báº£ng:")
        for col in columns:
            print(f"  - {col[0]:15} | {col[1]:30} | Null: {col[2]}")
        
        cursor.close()
        conn.close()
        print("\nâœ… Cáº¥u trÃºc báº£ng OK!")
        return True
    except Exception as e:
        print(f"âŒ Lá»—i: {e}")
        return False


def test_create_request():
    """Test 3: Táº¡o yÃªu cáº§u nghá»‰ phÃ©p má»›i"""
    print("\n" + "=" * 60)
    print("TEST 3: Táº¡o yÃªu cáº§u nghá»‰ phÃ©p TEST")
    print("=" * 60)
    
    controller = LeaveRequestController()
    
    # Táº¡o yÃªu cáº§u test
    success, message = controller.create_request(
        employee_id=1,  # Giáº£ sá»­ employee ID = 1 tá»“n táº¡i
        leave_type="Nghá»‰ phÃ©p nÄƒm",
        start_date_str="2025-12-01",
        end_date_str="2025-12-03",
        reason="Test tÃ­nh nÄƒng yÃªu cáº§u nghá»‰ phÃ©p - Auto generated by test script"
    )
    
    if success:
        print(f"âœ… {message}")
        return True
    else:
        print(f"âŒ {message}")
        return False


def test_get_requests():
    """Test 4: Láº¥y danh sÃ¡ch yÃªu cáº§u"""
    print("\n" + "=" * 60)
    print("TEST 4: Láº¥y danh sÃ¡ch yÃªu cáº§u cá»§a employee_id=1")
    print("=" * 60)
    
    controller = LeaveRequestController()
    requests = controller.get_my_requests(employee_id=1)
    
    print(f"\nTÃ¬m tháº¥y {len(requests)} yÃªu cáº§u:")
    
    for i, req in enumerate(requests[:5], 1):  # Chá»‰ hiá»ƒn thá»‹ 5 yÃªu cáº§u Ä‘áº§u
        print(f"\n  [{i}] ID: {req['id']}")
        print(f"      Loáº¡i: {req['leave_type_display']}")
        print(f"      Tá»«: {req['start_date']} â†’ {req['end_date']}")
        print(f"      Sá»‘ ngÃ y: {req['total_days']}")
        print(f"      Tráº¡ng thÃ¡i: {req['status_display']}")
        print(f"      LÃ½ do: {req['reason'][:50]}...")
    
    if len(requests) > 5:
        print(f"\n  ... vÃ  {len(requests) - 5} yÃªu cáº§u khÃ¡c")
    
    print(f"\nâœ… Láº¥y danh sÃ¡ch thÃ nh cÃ´ng!")
    return True


def test_validation():
    """Test 5: Kiá»ƒm tra validation"""
    print("\n" + "=" * 60)
    print("TEST 5: Kiá»ƒm tra validation")
    print("=" * 60)
    
    controller = LeaveRequestController()
    
    # Test 5.1: Thiáº¿u thÃ´ng tin
    print("\n[5.1] Test thiáº¿u thÃ´ng tin:")
    success, message = controller.create_request(
        employee_id=1,
        leave_type="Nghá»‰ phÃ©p nÄƒm",
        start_date_str="",
        end_date_str="2025-12-01",
        reason="Test"
    )
    print(f"  {'âœ…' if not success else 'âŒ'} {message}")
    
    # Test 5.2: LÃ½ do quÃ¡ ngáº¯n
    print("\n[5.2] Test lÃ½ do quÃ¡ ngáº¯n:")
    success, message = controller.create_request(
        employee_id=1,
        leave_type="Nghá»‰ phÃ©p nÄƒm",
        start_date_str="2025-12-01",
        end_date_str="2025-12-01",
        reason="Ngáº¯n"
    )
    print(f"  {'âœ…' if not success else 'âŒ'} {message}")
    
    # Test 5.3: NgÃ y khÃ´ng há»£p lá»‡
    print("\n[5.3] Test Ä‘á»‹nh dáº¡ng ngÃ y sai:")
    success, message = controller.create_request(
        employee_id=1,
        leave_type="Nghá»‰ phÃ©p nÄƒm",
        start_date_str="01-12-2025",  # Sai Ä‘á»‹nh dáº¡ng
        end_date_str="2025-12-01",
        reason="LÃ½ do há»£p lá»‡ dÃ i hÆ¡n 10 kÃ½ tá»±"
    )
    print(f"  {'âœ…' if not success else 'âŒ'} {message}")
    
    # Test 5.4: Start > End
    print("\n[5.4] Test ngÃ y báº¯t Ä‘áº§u > ngÃ y káº¿t thÃºc:")
    success, message = controller.create_request(
        employee_id=1,
        leave_type="Nghá»‰ phÃ©p nÄƒm",
        start_date_str="2025-12-10",
        end_date_str="2025-12-01",
        reason="LÃ½ do há»£p lá»‡ dÃ i hÆ¡n 10 kÃ½ tá»±"
    )
    print(f"  {'âœ…' if not success else 'âŒ'} {message}")
    
    # Test 5.5: NgÃ y quÃ¡ khá»©
    print("\n[5.5] Test ngÃ y trong quÃ¡ khá»©:")
    success, message = controller.create_request(
        employee_id=1,
        leave_type="Nghá»‰ phÃ©p nÄƒm",
        start_date_str="2020-01-01",
        end_date_str="2020-01-05",
        reason="LÃ½ do há»£p lá»‡ dÃ i hÆ¡n 10 kÃ½ tá»±"
    )
    print(f"  {'âœ…' if not success else 'âŒ'} {message}")
    
    print("\nâœ… Táº¥t cáº£ validation hoáº¡t Ä‘á»™ng Ä‘Ãºng!")
    return True


def show_summary():
    """Hiá»ƒn thá»‹ tá»•ng káº¿t"""
    print("\n" + "=" * 60)
    print("ğŸ“Š Tá»”NG Káº¾T")
    print("=" * 60)
    
    try:
        conn = create_connection()
        cursor = conn.cursor(dictionary=True)
        
        # Tá»•ng sá»‘ yÃªu cáº§u
        cursor.execute("SELECT COUNT(*) as total FROM leave_requests")
        total = cursor.fetchone()['total']
        
        # Sá»‘ yÃªu cáº§u theo tráº¡ng thÃ¡i
        cursor.execute("""
            SELECT status, COUNT(*) as count 
            FROM leave_requests 
            GROUP BY status
        """)
        status_counts = cursor.fetchall()
        
        print(f"\nğŸ“‹ Tá»•ng sá»‘ yÃªu cáº§u: {total}")
        print("\nPhÃ¢n bá»‘ theo tráº¡ng thÃ¡i:")
        for stat in status_counts:
            status_map = {
                'pending': 'ğŸŸ  Chá» duyá»‡t',
                'approved': 'ğŸŸ¢ ÄÃ£ duyá»‡t',
                'rejected': 'ğŸ”´ ÄÃ£ tá»« chá»‘i'
            }
            status_text = status_map.get(stat['status'], stat['status'])
            print(f"  {status_text}: {stat['count']}")
        
        cursor.close()
        conn.close()
        
    except Exception as e:
        print(f"âŒ Lá»—i: {e}")


if __name__ == "__main__":
    print("\n" + "ğŸ§ª" * 30)
    print("   LEAVE REQUEST SYSTEM - TEST SUITE")
    print("ğŸ§ª" * 30)
    
    # Cháº¡y cÃ¡c test
    test_database_connection()
    test_table_structure()
    test_create_request()
    test_get_requests()
    test_validation()
    show_summary()
    
    print("\n" + "âœ…" * 30)
    print("   HOÃ€N THÃ€NH Táº¤T Cáº¢ TEST!")
    print("âœ…" * 30 + "\n")
